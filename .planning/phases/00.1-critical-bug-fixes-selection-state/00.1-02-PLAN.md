---
phase: 00.1-critical-bug-fixes-selection-state
plan: 02
type: execute
wave: 2
depends_on: ["00.1-01"]
files_modified:
  - epicTreeGUI.m
autonomous: true

must_haves:
  truths:
    - "GUI has a 'Save Epoch Mask' button in the File menu"
    - "Clicking 'Save Epoch Mask' saves current selection state to a .ugm file"
    - "If .ugm files already exist, user is prompted to replace latest or create new"
    - "GUI stores matFilePath so .ugm files can be discovered in the same directory"
  artifacts:
    - path: "epicTreeGUI.m"
      provides: "Save Epoch Mask menu item, matFilePath property, onSaveEpochMask callback"
      contains: "Save Epoch Mask, onSaveEpochMask, matFilePath"
  key_links:
    - from: "epicTreeGUI.onSaveEpochMask"
      to: "epicTreeTools.saveUserMetadata"
      via: "Builds .ugm filepath, calls tree.saveUserMetadata(filepath)"
    - from: "epicTreeGUI.onSaveEpochMask"
      to: "epicTreeTools.findLatestUGM"
      via: "Checks for existing .ugm files to offer replace/create choice"
---

<objective>
Add "Save Epoch Mask" functionality to the GUI, allowing users to persist their epoch selection state to .ugm files.

Purpose: Per the user's locked decision, selection state should be manually saved via a GUI button labeled "Save Epoch Mask". This completes the user-facing persistence workflow: users make selections in the tree, then explicitly save when ready.

Output: Updated epicTreeGUI.m with Save Epoch Mask menu item, matFilePath property, and save callback with replace/create dialog.
</objective>

<execution_context>
@/Users/maxwellsdm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maxwellsdm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00.1-critical-bug-fixes-selection-state/00.1-CONTEXT.md
@.planning/phases/00.1-critical-bug-fixes-selection-state/00.1-RESEARCH.md
@.planning/phases/00.1-critical-bug-fixes-selection-state/00.1-01-SUMMARY.md
@epicTreeGUI.m
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add matFilePath property and wire it from constructor</name>
  <files>epicTreeGUI.m</files>
  <action>
**Part A: Add matFilePath property**

In the properties block of epicTreeGUI.m (around line 28-42), add a new property:

```matlab
matFilePath = ''        % Path to source .mat file (for .ugm file discovery)
```

Add it after the `h5File` property (line 32).

**Part B: Wire matFilePath from tree's sourceFile**

In the constructor (around line 84-130), after `self.tree = treeObj` and `self.allEpochs = self.tree.allEpochs` are set, add:

```matlab
% Store .mat file path for .ugm file persistence
if ~isempty(self.tree.sourceFile)
    self.matFilePath = self.tree.sourceFile;
end
```

This ensures the GUI knows where the .mat file lives so it can discover/create .ugm files in the same directory.

**Part C: Also set tree.sourceFile if GUI can determine it**

The GUI currently resolves H5 files from `epicTreeConfig()`. If the config also has a `mat_dir` or the tree's sourceFile is empty, we should allow the user to set matFilePath directly. Add a convenience method:

```matlab
function setDataSource(self, matFilePath)
    % SETDATASOURCE Set the source .mat file path for .ugm persistence
    self.matFilePath = matFilePath;
    if ~isempty(self.tree)
        self.tree.sourceFile = matFilePath;
    end
end
```

Place this in the public methods section (after the constructor).
  </action>
  <verify>
Read epicTreeGUI.m and verify:
1. `matFilePath` property exists in properties block
2. Constructor sets matFilePath from tree.sourceFile
3. `setDataSource()` method exists
  </verify>
  <done>
- epicTreeGUI has `matFilePath` property
- Constructor copies tree.sourceFile to matFilePath automatically
- `setDataSource()` allows explicit path setting
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Save Epoch Mask menu item and callback</name>
  <files>epicTreeGUI.m</files>
  <action>
**Part A: Add menu item to buildMenuBar()**

In the `buildMenuBar()` method (line 281-298), add a "Save Epoch Mask..." menu item to the File menu, between "Export Selection..." and "Close":

```matlab
uimenu(fileMenu, 'Label', 'Save Epoch Mask...', ...
    'Callback', @(src,evt) self.onSaveEpochMask(), ...
    'Separator', 'on');
```

The "Close" item should still have its separator. Move the separator from "Close" to "Save Epoch Mask" won't work visually. Instead, keep "Close" separator and add "Save Epoch Mask" without separator:

Final File menu order:
1. Export Selection...
2. Save Epoch Mask... (new, with separator above)
3. ---
4. Close

So in code:
```matlab
fileMenu = uimenu(self.figure, 'Label', 'File');
uimenu(fileMenu, 'Label', 'Export Selection...', 'Callback', @(src,evt) self.onExportSelection());
uimenu(fileMenu, 'Label', 'Save Epoch Mask...', 'Callback', @(src,evt) self.onSaveEpochMask());
uimenu(fileMenu, 'Label', 'Close', 'Callback', @(src,evt) self.onClose(), 'Separator', 'on');
```

**Part B: Implement onSaveEpochMask() callback**

Add a private method `onSaveEpochMask(self)` in the private methods section.

Implementation per research Example 6, adapted for the locked decisions:

```matlab
function onSaveEpochMask(self)
    % Save current selection state to .ugm file

    % Validate we have data and path
    if isempty(self.tree) || isempty(self.tree.allEpochs)
        errordlg('No data loaded.', 'Save Epoch Mask');
        return;
    end

    if isempty(self.matFilePath)
        % Ask user to specify the .mat file path
        [file, path] = uigetfile('*.mat', 'Select the source .mat file for this dataset');
        if file == 0
            return;  % User cancelled
        end
        self.matFilePath = fullfile(path, file);
        self.tree.sourceFile = self.matFilePath;
    end

    % Find existing .ugm files
    latestUGM = epicTreeTools.findLatestUGM(self.matFilePath);

    if isempty(latestUGM)
        % No existing files - create new
        filepath = epicTreeTools.generateUGMFilename(self.matFilePath);
        self.tree.saveUserMetadata(filepath);
        msgbox(sprintf('Selection mask saved to:\n%s', filepath), 'Epoch Mask Saved');
    else
        % Existing files found - ask user
        % Use questdlg for broader MATLAB compatibility (works pre-R2020a too)
        choice = questdlg(...
            sprintf('Found existing selection file:\n%s\n\nReplace it or create a new one?', latestUGM), ...
            'Save Epoch Mask', ...
            'Replace Latest', 'Create New', 'Cancel', ...
            'Create New');

        switch choice
            case 'Replace Latest'
                self.tree.saveUserMetadata(latestUGM);
                msgbox(sprintf('Selection mask updated:\n%s', latestUGM), 'Epoch Mask Saved');
            case 'Create New'
                filepath = epicTreeTools.generateUGMFilename(self.matFilePath);
                self.tree.saveUserMetadata(filepath);
                msgbox(sprintf('Selection mask saved to:\n%s', filepath), 'Epoch Mask Saved');
            case 'Cancel'
                % Do nothing
        end
    end
end
```

Note: Using `questdlg()` instead of `uiconfirm()` for broader MATLAB version compatibility. `questdlg()` works with all MATLAB versions while `uiconfirm()` requires R2020a+ with App Designer figures.
  </action>
  <verify>
Read epicTreeGUI.m and verify:
1. "Save Epoch Mask..." menu item exists in buildMenuBar
2. `onSaveEpochMask()` method exists in private methods
3. Method checks for empty data and empty matFilePath
4. Method uses questdlg for replace/create choice
5. Method calls `epicTreeTools.saveUserMetadata()` and `epicTreeTools.generateUGMFilename()`

Then test using MCP MATLAB:
```matlab
% Quick smoke test - just verify the method exists
gui = epicTreeGUI();  % May error due to no tree, that's ok
methods(gui)  % Should list onSaveEpochMask
```
  </verify>
  <done>
- "Save Epoch Mask..." menu item appears in File menu
- Clicking it when no data loaded shows error dialog
- Clicking it when matFilePath is empty prompts for .mat file
- Clicking it with existing .ugm files shows Replace/Create/Cancel dialog
- Clicking it with no existing .ugm files creates new .ugm file directly
- Selection mask is saved via epicTreeTools.saveUserMetadata()
  </done>
</task>

</tasks>

<verification>
1. "Save Epoch Mask..." menu item exists in GUI File menu
2. `matFilePath` property is populated from tree.sourceFile in constructor
3. Save callback handles all three cases: no data, no existing .ugm, existing .ugm
4. Dialog prompts user with Replace/Create/Cancel when .ugm files exist
5. No regression: existing GUI functionality unchanged
</verification>

<success_criteria>
- GUI has functional "Save Epoch Mask" button in File menu per user's locked decision
- matFilePath flows correctly from tree.sourceFile to GUI
- Save dialog matches user's specification: "Replace existing mask or create new one?"
- .ugm files are created in the same directory as the .mat file
</success_criteria>

<output>
After completion, create `.planning/phases/00.1-critical-bug-fixes-selection-state/00.1-02-SUMMARY.md`
</output>
