# Phase 0.1: Critical Bug Fixes - Selection State - Context

**Gathered:** 2026-02-08
**Status:** Ready for planning

<domain>
## Phase Boundary

Fix BUG-001: Selection state not persisting/propagating. Currently when users deselect epochs, `selectedCount()` reports correctly but `getAllEpochs(true)` and `getSelectedData()` return ALL epochs instead of only selected ones. This breaks the core epoch filtering workflow.

**Scope:** Fix the selection state architecture only. Do NOT add new features or expand capabilities.

</domain>

<decisions>
## Implementation Decisions

### Three-File Architecture

**The system has three data layers:**

1. **Raw H5 files** (`experiment.h5`) - Optional, read-only, never modified
2. **Exported metadata** (`experiment.mat`) - Required, contains epoch structure from Python export
3. **User-generated metadata** (`experiment_YYYY-MM-DD_HH-MM-SS.ugm`) - Optional, contains selection mask

**Key principle:** Keep user modifications (selections) separate from raw experiment data.

### User Metadata (.ugm) Files

**Location:** Same directory as .mat file (keeps related files together)

**Naming convention:** Timestamped sessions
- Format: `{basename}_YYYY-MM-DD_HH-MM-SS.ugm`
- Example: `experiment_2025-12-02_2026-02-08_14-30-45.ugm`
- Auto-generated timestamp, not user-named

**Content:** Selection mask only
- Just which epochs are selected/deselected
- Do NOT include: analysis results, tree structure, GUI state
- Keep it simple and focused

**Save behavior:** Manual save via GUI button
- Button labeled "Save Epoch Mask" in GUI
- On click: prompt user "Replace existing mask or create new one?"
- NOT auto-save (user has explicit control)

**Load behavior:** Default to auto-load latest if exists
```matlab
% Default: auto-load latest .ugm if exists, else all selected
tree = epicTreeTools(data);

% Explicit options:
tree = epicTreeTools(data, 'LoadUserMetadata', 'latest');    % newest timestamp
tree = epicTreeTools(data, 'LoadUserMetadata', 'filename.ugm'); % specific file
tree = epicTreeTools(data, 'LoadUserMetadata', 'none');      % start fresh
```

**Finding "latest":**
- If only one .ugm file exists → use it
- If multiple exist → parse timestamps from filenames, use newest
- If none exist → all epochs selected by default

### Selection State Storage

**Per-epoch flag approach:**
- Each epoch has: `epoch.isSelected = true/false`
- This is the individual epoch's selection state
- Simple to query: "is this epoch selected?"

**Hierarchy-aware propagation:**
- When parent node deselected → auto-deselect ALL children recursively
- User workflow: deselect entire groups (cell types, protocols) not fine-grained individual epochs
- No complex bi-directional sync needed
- No partial/indeterminate checkbox states needed

**Root node behavior:**
- Selecting root → select all epochs in tree
- Deselecting root → deselect all epochs in tree
- Simple "select all" / "deselect all" convenience

### Tree Initialization with User Metadata

**Default behavior (no arguments):**
```matlab
tree = epicTreeTools(data);
% → Auto-loads latest .ugm if any exist
% → If no .ugm files: all epochs selected by default
```

**Explicit control options:**
- `'LoadUserMetadata', 'latest'` - Use newest .ugm file (error if none exist)
- `'LoadUserMetadata', 'filename.ugm'` - Use specific .ugm file
- `'LoadUserMetadata', 'none'` - Start fresh, ignore any .ugm files

**File discovery:**
- Search same directory as .mat file
- Pattern: `{mat_basename}_*.ugm`
- Parse timestamps from filenames to find newest

### Selection Methods Fix

**The core bug fix:**

`getAllEpochs(onlySelected=true)` must filter by `epoch.isSelected`:
```matlab
function epochs = getAllEpochs(obj, onlySelected)
    epochs = obj.allEpochs;
    if onlySelected
        % Filter to only selected epochs
        selected = cellfun(@(e) e.isSelected, epochs);
        epochs = epochs(selected);
    end
end
```

`getSelectedData()` must respect `isSelected` flag:
- Already calls `getAllEpochs(true)` internally
- If `getAllEpochs()` is fixed, `getSelectedData()` should work

`setSelected()` must actually set the flag:
```matlab
function setSelected(obj, epochs, state, recursive)
    % Set isSelected flag on specified epochs
    for i = 1:length(epochs)
        epochs{i}.isSelected = state;
    end

    % If recursive and this is a node, propagate to children
    if recursive && hasChildren(node)
        % Recursively set children
    end
end
```

### Claude's Discretion

- Exact .ugm file format (MAT file, JSON, binary?)
- Error handling when .ugm file is corrupted or version mismatch
- Migration strategy if .ugm format changes in future
- Performance optimizations (caching, lazy loading)
- Exact timestamp format in filename (as long as sortable)

</decisions>

<specifics>
## Specific Ideas

**User's conceptual model:**
- "Three files to initialize the tree: H5 (optional), .mat (required), .ugm (optional)"
- "Selection mask is user-generated metadata, kept separate from raw data"
- "Most users will just keep one .ugm file and keep updating it"

**Key insight from testing:**
- `selectedCount()` already works correctly (returns 958 after deselecting half)
- This means selection state IS being tracked somewhere
- The bug is that `getAllEpochs(true)` doesn't filter by it
- So the fix might be simpler than a full rewrite - just fix the filtering logic

**Workflow emphasis:**
- Users typically deselect entire groups (cell types, protocols)
- NOT typically fine-grained individual epoch selection
- Therefore simple parent→children propagation is sufficient

</specifics>

<deferred>
## Deferred Ideas

None - discussion stayed focused on fixing the selection state bug only.

</deferred>

---

*Phase: 00.1-critical-bug-fixes-selection-state*
*Context gathered: 2026-02-08*
