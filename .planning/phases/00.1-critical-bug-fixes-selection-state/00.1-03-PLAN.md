---
phase: 00.1-critical-bug-fixes-selection-state
plan: 03
type: execute
wave: 2
depends_on: ["00.1-01"]
files_modified:
  - tests/test_selection_state.m
  - tests/test_ugm_persistence.m
autonomous: true

must_haves:
  truths:
    - "Test suite validates setSelected + getAllEpochs(true) filtering works end-to-end"
    - "Test suite validates .ugm save/load round-trip preserves selection state"
    - "Test suite validates constructor LoadUserMetadata options"
    - "Test suite validates hierarchy-aware propagation (parent deselect cascades to children)"
    - "Test suite validates .ugm file validation catches epoch count mismatch"
  artifacts:
    - path: "tests/test_selection_state.m"
      provides: "Selection state filtering tests"
      contains: "testSetSelectedDeselectsEpochs, testGetAllEpochsFiltersBySelection, testRecursiveDeselect, testRootSelectAll"
    - path: "tests/test_ugm_persistence.m"
      provides: "UGM file persistence tests"
      contains: "testSaveAndLoadRoundTrip, testEpochCountMismatchWarns, testFindLatestUGM, testConstructorLoadOptions"
  key_links:
    - from: "tests/test_selection_state.m"
      to: "epicTreeTools.setSelected, epicTreeTools.getAllEpochs"
      via: "Direct method calls on tree with real data"
    - from: "tests/test_ugm_persistence.m"
      to: "epicTreeTools.saveUserMetadata, epicTreeTools.loadUserMetadata, epicTreeTools.findLatestUGM"
      via: "Save/load round-trips with temp directory"
---

<objective>
Write comprehensive tests validating selection state filtering and .ugm persistence, ensuring BUG-001 is fixed and the three-file architecture works correctly.

Purpose: Phase 0.1 success criteria #4 requires "Tests validate selection filtering works end-to-end." These tests serve as regression guards ensuring the critical selection workflow never breaks again, and that .ugm file persistence works reliably.

Output: Two test files covering selection state management and .ugm file persistence.
</objective>

<execution_context>
@/Users/maxwellsdm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maxwellsdm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00.1-critical-bug-fixes-selection-state/00.1-CONTEXT.md
@.planning/phases/00.1-critical-bug-fixes-selection-state/00.1-RESEARCH.md
@.planning/phases/00.1-critical-bug-fixes-selection-state/00.1-01-SUMMARY.md
@src/tree/epicTreeTools.m
@src/getSelectedData.m
@BUGS_FOUND_PHASE0.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write selection state filtering tests</name>
  <files>tests/test_selection_state.m</files>
  <action>
Create `tests/test_selection_state.m` as a MATLAB test class using the `matlab.unittest.TestCase` framework.

**Test data:** Use real data from `/Users/maxwellsdm/Documents/epicTreeTest/analysis/2025-12-02_F.mat` (absolute path per decision from 00-01). Use `TestMethodSetup` to create a fresh tree for each test, preventing state leakage (decision from 00-01).

**Test class structure:**

```matlab
classdef test_selection_state < matlab.unittest.TestCase
    % TEST_SELECTION_STATE Validate selection filtering (BUG-001 regression tests)

    properties
        TestDataPath = '/Users/maxwellsdm/Documents/epicTreeTest/analysis/2025-12-02_F.mat';
        TreeData
    end

    methods (TestClassSetup)
        function loadData(testCase)
            testCase.assumeTrue(exist(testCase.TestDataPath, 'file') == 2, ...
                'Test data file not found');
            [testCase.TreeData, ~] = loadEpicTreeData(testCase.TestDataPath);
        end
    end
end
```

**Tests to include:**

1. **testSetSelectedDeselectsAllEpochs** - Build tree, get leaf, call `setSelected(false, true)`, verify `getAllEpochs(true)` returns empty.

2. **testSetSelectedReselectsAllEpochs** - Deselect then reselect leaf, verify epoch count matches original.

3. **testRecursiveDeselect** - Build multi-level tree, deselect an internal node recursively, verify all descendant leaves' epochs are deselected.

4. **testRootDeselectAll** - Call `tree.setSelected(false, true)` on root, verify `tree.getAllEpochs(true)` returns empty for entire tree.

5. **testRootReselectAll** - After deselecting root, reselect root recursively, verify all epochs restored.

6. **testPartialSelection** - Deselect one child, keep another selected. Verify `getAllEpochs(true)` from root returns only the selected child's epochs.

7. **testGetSelectedDataRespectsSelection** - Deselect a child, call `getSelectedData(tree, streamName)` (auto-detect stream name from first epoch's responses). Verify returned data has fewer rows than total epoch count. If no stream is available, use `assumeFail()` to skip gracefully.

8. **testSelectedCountMatchesGetAllEpochs** - After partial deselection, verify `selectedCount()` equals `length(getAllEpochs(true))`.

9. **testDirectEpochModificationDoesNotWork** - Document the anti-pattern. Get epochs via `getAllEpochs(false)`, modify `isSelected` on returned copies, verify that `getAllEpochs(true)` is NOT affected (proving the struct copy behavior). This documents the root cause of BUG-001.

10. **testRefreshNodeSelectionState** - Manually set `isSelected = false` on some leaf epochList items (direct access, not via returned copy), then call `refreshNodeSelectionState()` on root. Verify node.custom.isSelected reflects actual epoch states.

**IMPORTANT anti-patterns to document in test comments:**
- "Do NOT modify epochs returned by getAllEpochs() - these are copies. Use setSelected() instead."
- Each test should have a descriptive comment explaining what it validates and why.
  </action>
  <verify>
Run the test file using MCP MATLAB:
```matlab
results = runtests('/Users/maxwellsdm/Documents/GitHub/epicTreeGUI/tests/test_selection_state.m');
disp(results);
```
All tests should pass (or skip gracefully if test data unavailable).
  </verify>
  <done>
- 10 tests covering all selection state scenarios
- Tests validate BUG-001 is fixed (setSelected + getAllEpochs filtering)
- Tests document the anti-pattern (direct epoch modification creates copies)
- Tests validate hierarchy-aware propagation (parent to children)
- Tests validate root select/deselect all behavior
- All tests pass with real data or skip gracefully if data unavailable
  </done>
</task>

<task type="auto">
  <name>Task 2: Write .ugm persistence tests</name>
  <files>tests/test_ugm_persistence.m</files>
  <action>
Create `tests/test_ugm_persistence.m` as a MATLAB test class.

**Test infrastructure:** Use a temporary directory for .ugm file creation/cleanup. Use `TestMethodSetup`/`TestMethodTeardown` to create and clean temp dir.

```matlab
classdef test_ugm_persistence < matlab.unittest.TestCase
    % TEST_UGM_PERSISTENCE Validate .ugm file save/load/find operations

    properties
        TestDataPath = '/Users/maxwellsdm/Documents/epicTreeTest/analysis/2025-12-02_F.mat';
        TreeData
        TempDir
        TempMatPath  % Simulated .mat path in temp dir for .ugm file discovery
    end

    methods (TestClassSetup)
        function loadData(testCase)
            testCase.assumeTrue(exist(testCase.TestDataPath, 'file') == 2, ...
                'Test data file not found');
            [testCase.TreeData, ~] = loadEpicTreeData(testCase.TestDataPath);
        end
    end

    methods (TestMethodSetup)
        function createTempDir(testCase)
            testCase.TempDir = tempname;
            mkdir(testCase.TempDir);
            % Create a fake .mat file path in temp dir for .ugm naming
            testCase.TempMatPath = fullfile(testCase.TempDir, 'test_data.mat');
            % Copy or create a dummy .mat file so fileparts works
        end
    end

    methods (TestMethodTeardown)
        function cleanupTempDir(testCase)
            if exist(testCase.TempDir, 'dir')
                rmdir(testCase.TempDir, 's');
            end
        end
    end
end
```

**Tests to include:**

1. **testSaveCreatesUGMFile** - Create tree, save .ugm, verify file exists on disk.

2. **testSaveContainsCorrectFields** - Save .ugm, load it back with MATLAB `load()`, verify struct has: version, created, epoch_count, selection_mask, mat_file_basename.

3. **testSaveAndLoadRoundTrip** - Deselect half the epochs, save, create fresh tree, load .ugm, verify same selection state. Compare epoch counts match.

4. **testSelectionMaskLength** - Save .ugm, verify `length(ugm.selection_mask) == tree.epochCount()`.

5. **testLoadValidatesEpochCount** - Create .ugm with wrong epoch_count (manually modify), attempt load, verify it warns and returns false.

6. **testLoadMissingFile** - Attempt to load nonexistent .ugm file, verify returns false with warning.

7. **testLoadCorruptedFile** - Create an invalid .ugm file (not a MAT file), attempt load, verify returns false with warning.

8. **testFindLatestUGMNoFiles** - Call findLatestUGM on a directory with no .ugm files, verify returns empty string.

9. **testFindLatestUGMSingleFile** - Create one .ugm file, verify findLatestUGM returns it.

10. **testFindLatestUGMMultipleFiles** - Create multiple .ugm files with different timestamps (use `pause(1)` between to ensure different timestamps, or manually name them with different timestamps), verify findLatestUGM returns the newest.

11. **testGenerateUGMFilename** - Call generateUGMFilename, verify it returns a path in the same directory as the .mat file, with .ugm extension, containing a timestamp pattern.

12. **testConstructorLoadUserMetadataNone** - Create tree with `'LoadUserMetadata', 'none'`, verify all epochs selected even if .ugm file exists.

13. **testConstructorLoadUserMetadataAuto** - Create and save a .ugm file with partial selection, then create new tree with default `'auto'` option and sourceFile set. Verify the selection is loaded.

**Implementation notes:**
- For tests needing different timestamps, create .ugm files manually with `save()` using names like `test_data_2026-01-01_00-00-00.ugm` and `test_data_2026-01-02_00-00-00.ugm`.
- Use `testCase.verifyWarning()` or `testCase.assertWarning()` for tests expecting warnings.
- Clean up all created files in teardown.
  </action>
  <verify>
Run the test file using MCP MATLAB:
```matlab
results = runtests('/Users/maxwellsdm/Documents/GitHub/epicTreeGUI/tests/test_ugm_persistence.m');
disp(results);
```
All tests should pass (or skip gracefully if test data unavailable).
  </verify>
  <done>
- 13 tests covering .ugm save, load, find, generate, and constructor options
- Round-trip test proves selection state persists correctly across sessions
- Validation tests prove corrupted/mismatched .ugm files are handled gracefully
- findLatestUGM tests prove timestamp sorting works
- Constructor option tests prove 'auto', 'none', and explicit file loading work
- All tests pass with real data or skip gracefully if data unavailable
  </done>
</task>

</tasks>

<verification>
1. Run `runtests('tests/test_selection_state.m')` - all tests pass
2. Run `runtests('tests/test_ugm_persistence.m')` - all tests pass
3. Combined: `runtests('tests/test_selection_state.m', 'tests/test_ugm_persistence.m')` - all pass
4. No temp files left behind after test runs
</verification>

<success_criteria>
- Selection state tests prove BUG-001 is fixed with 10 test cases
- .ugm persistence tests prove three-file architecture works with 13 test cases
- All tests use real data from test data path or skip gracefully
- Tests serve as regression guards for future development
- Anti-pattern (direct epoch struct modification) is documented in test comments
</success_criteria>

<output>
After completion, create `.planning/phases/00.1-critical-bug-fixes-selection-state/00.1-03-SUMMARY.md`
</output>
