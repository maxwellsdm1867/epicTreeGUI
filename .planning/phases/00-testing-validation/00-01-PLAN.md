---
phase: 00-testing-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/helpers/loadTestTree.m
  - tests/helpers/getTestDataPath.m
  - tests/unit/TreeNavigationTest.m
  - TESTING_REPORT.md
autonomous: true

must_haves:
  truths:
    - "Test framework loads real data and builds tree without errors"
    - "Tree navigation methods (childAt, parentAt, getAllEpochs, leafNodes, childBySplitValue) return correct results"
    - "Controlled access methods (putCustom, getCustom, hasCustom, removeCustom) work correctly"
    - "Selection filtering returns only selected epochs"
  artifacts:
    - path: "tests/helpers/loadTestTree.m"
      provides: "Shared test data loading function"
      contains: "function.*loadTestTree"
    - path: "tests/helpers/getTestDataPath.m"
      provides: "Centralized test data path resolution"
      contains: "function.*getTestDataPath"
    - path: "tests/unit/TreeNavigationTest.m"
      provides: "Class-based tree navigation tests"
      contains: "classdef TreeNavigationTest"
    - path: "TESTING_REPORT.md"
      provides: "Bug/issue tracking document"
      contains: "Testing Report"
  key_links:
    - from: "tests/unit/TreeNavigationTest.m"
      to: "tests/helpers/loadTestTree.m"
      via: "loadTestTree() call in TestClassSetup"
      pattern: "loadTestTree"
    - from: "tests/helpers/loadTestTree.m"
      to: "src/tree/epicTreeTools.m"
      via: "epicTreeTools constructor and buildTree"
      pattern: "epicTreeTools"
---

<objective>
Set up the test framework infrastructure and validate all tree navigation and controlled access methods with real experiment data.

Purpose: Establish the foundation that all subsequent test plans depend on -- shared data loading helpers and the first batch of correctness tests for the core tree API. Tree navigation is the most critical subsystem since every analysis function, splitter, and GUI interaction depends on it.

Output: Shared test helpers (loadTestTree.m, getTestDataPath.m), comprehensive TreeNavigationTest class, and initialized TESTING_REPORT.md for tracking bugs/issues found during Phase 0.
</objective>

<execution_context>
@/Users/maxwellsdm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maxwellsdm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-testing-validation/00-CONTEXT.md
@.planning/phases/00-testing-validation/00-RESEARCH.md

# Source files being tested
@src/tree/epicTreeTools.m
@src/getSelectedData.m
@src/loadEpicTreeData.m

# Existing test patterns to reference
@tests/test_tree_navigation.m
@tests/test_selection_navigation.m
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test infrastructure (shared helpers + TESTING_REPORT.md)</name>
  <files>
    tests/helpers/loadTestTree.m
    tests/helpers/getTestDataPath.m
    TESTING_REPORT.md
  </files>
  <action>
Create the test infrastructure that all subsequent test files will use.

1. Create `tests/helpers/getTestDataPath.m`:
   - Function that returns the absolute path to test data file
   - Use hardcoded relative path from repo root: `fullfile(fileparts(fileparts(fileparts(mfilename('fullpath')))), 'test_data', 'sample_data.mat')` (goes up from helpers/ -> tests/ -> repo root, then into test_data/)
   - Verify file exists, error with helpful message if not (tell user to run data prep step)
   - Also provide a function for H5 directory path resolution

2. Create `tests/helpers/loadTestTree.m`:
   - Function signature: `function [tree, data, h5File] = loadTestTree(splitKeys)`
   - Default splitKeys: `{'cellInfo.type'}` if not provided
   - Calls `getTestDataPath()` to find data
   - Loads data using `loadEpicTreeData()`
   - Creates epicTreeTools and builds tree with provided splitKeys
   - Returns tree object, raw data, and h5File path
   - Add `addpath(genpath(...))` to ensure src/ is on path
   - Handle both splitter function handles and key path strings

3. Create `TESTING_REPORT.md`:
   - Title: "EpicTreeGUI Phase 0 Testing Report"
   - Sections: Summary, Bugs Found, Performance Issues, Design Inconsistencies, Test Coverage Summary
   - Each section has a table template with columns: ID, Description, Severity, Status, Fix Commit
   - Initialize with empty tables (will be populated during testing)

NOTE: Test data file (test_data/sample_data.mat) must already exist from pre-phase setup by user. The helper should error clearly if it's missing.
  </action>
  <verify>
    Run via MCP MATLAB tools:
    - `addpath(genpath('tests/helpers')); addpath(genpath('src'));`
    - `path = getTestDataPath();` should return valid path or clear error
    - `[tree, data, h5] = loadTestTree();` should build tree successfully (if test data exists)
    - Verify TESTING_REPORT.md exists and has expected section headers
  </verify>
  <done>
    loadTestTree() returns a valid epicTreeTools object with children when called with default arguments. getTestDataPath() returns the correct path. TESTING_REPORT.md is initialized with proper template structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive TreeNavigationTest class</name>
  <files>
    tests/unit/TreeNavigationTest.m
  </files>
  <action>
Create a class-based test file `tests/unit/TreeNavigationTest.m` that inherits from `matlab.unittest.TestCase`. This validates all tree navigation and controlled access methods with real data.

Test class structure:
```
classdef TreeNavigationTest < matlab.unittest.TestCase
    properties
        Tree
        Data
        H5File
    end
    methods (TestClassSetup)
        function loadData(testCase)
            % Use loadTestTree helper with multi-level splits
            % Build with: {'cellInfo.type', 'blockInfo.protocol_name'}
        end
    end
    methods (TestMethodSetup)
        function resetSelection(testCase)
            % Reset all epochs to selected before each test
            % Prevents test interference from selection state changes
        end
    end
end
```

Required test methods (each validates correctness, not just "no crash"):

**Navigation DOWN:**
- `testChildrenLength` - Verify childrenLength() returns expected count (>0, matches number of unique cell types)
- `testChildAt` - childAt(1) returns valid node with splitValue matching a known cell type
- `testChildAtOutOfBounds` - childAt(0) and childAt(N+1) throw error or return empty
- `testChildBySplitValue` - Find a known cell type by name, verify epoch counts match
- `testChildBySplitValueNotFound` - Unknown value returns empty
- `testLeafNodes` - leafNodes() returns cell array, all are actual leaves (childrenLength == 0)
- `testLeafNodesEpochCount` - Sum of all leaf epoch counts equals root epoch count (no epochs lost)

**Navigation UP:**
- `testParent` - child.parent returns the correct parent node
- `testParentOfRoot` - root.parent is empty
- `testParentAt` - parentAt(1) == parent, parentAt(depth) == root
- `testDepth` - Root depth is 0, first-level children depth is 1
- `testGetRoot` - Any node's getRoot() returns the root
- `testPathFromRoot` - Path length equals depth + 1
- `testPathString` - Contains separator character '>'

**Controlled Access:**
- `testPutGetCustom` - Store and retrieve struct, verify values match
- `testHasCustom` - Returns true for stored key, false for missing key
- `testRemoveCustom` - After removal, hasCustom returns false
- `testGetCustomMissing` - Returns empty for non-existent key
- `testCustomKeys` - Returns correct list of stored keys

**Selection and Epochs:**
- `testGetAllEpochsFalse` - Returns all epochs regardless of selection
- `testGetAllEpochsTrue` - After deselecting some, returns fewer epochs
- `testEpochCount` - Matches length of getAllEpochs(false)
- `testSelectedCount` - After deselecting, selectedCount < epochCount
- `testSetSelectedRecursive` - setSelected(false, true) deselects all descendants

**Tree Building:**
- `testBuildTreeSingleSplit` - Build with one key, verify structure
- `testBuildTreeMultiSplit` - Build with two keys, verify depth
- `testBuildTreeWithSplitters` - Build with function handle splitters
- `testRebuildTreePreservesEpochs` - Rebuilding with different keys preserves epoch count

Important implementation notes:
- Use `testCase.verifyEqual`, `testCase.verifyTrue`, `testCase.verifyEmpty`, `testCase.verifyGreaterThan` (not assert())
- Use `testCase.verifyNumElements` for array length checks
- Add tolerance for any floating-point comparisons: `'AbsTol', 1e-10`
- Each test should be independent (TestMethodSetup resets state)
- If any test discovers a bug, document it in TESTING_REPORT.md with a BUG-NNN ID
  </action>
  <verify>
    Run via MCP MATLAB tools:
    - `results = runtests('tests/unit/TreeNavigationTest');`
    - All tests pass (0 failures, 0 errors)
    - If any failures: fix the underlying bug (per user decision), document in TESTING_REPORT.md, re-run
  </verify>
  <done>
    TreeNavigationTest class has 25+ test methods covering all navigation, controlled access, selection, and tree building methods. All tests pass with real data. Any bugs found are fixed and documented in TESTING_REPORT.md.
  </done>
</task>

</tasks>

<verification>
1. `tests/helpers/loadTestTree.m` exists and successfully loads real test data
2. `tests/helpers/getTestDataPath.m` exists and returns valid path
3. `tests/unit/TreeNavigationTest.m` exists with 25+ test methods
4. `results = runtests('tests/unit/TreeNavigationTest')` - all pass
5. TESTING_REPORT.md initialized at repo root
6. Any bugs discovered during testing are fixed in source code and documented
</verification>

<success_criteria>
- Test infrastructure loads real experiment data without errors
- All tree navigation tests pass (childAt, parentAt, getAllEpochs, leafNodes, childBySplitValue, depth, pathFromRoot, getRoot, pathString)
- All controlled access tests pass (putCustom, getCustom, hasCustom, removeCustom, customKeys)
- All selection tests pass (getAllEpochs with filtering, setSelected recursive)
- All tree building tests pass (single/multi split, function handles, epoch preservation)
- Zero test failures when running the complete TreeNavigationTest suite
</success_criteria>

<output>
After completion, create `.planning/phases/00-testing-validation/00-01-SUMMARY.md`
</output>
