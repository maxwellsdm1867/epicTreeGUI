---
phase: 00-testing-validation
plan: 03
type: execute
wave: 2
depends_on: ["00-01"]
files_modified:
  - tests/unit/AnalysisFunctionsTest.m
  - tests/baselines/README.md
autonomous: true

must_haves:
  truths:
    - "getMeanResponseTrace returns struct with mean, stdev, SEM, timeVector, sampleRate fields"
    - "getResponseAmplitudeStats returns struct with peakAmplitude, integratedResponse, summary statistics"
    - "getCycleAverageResponse returns struct with cycleAverage, F1/F2 amplitudes (when applicable)"
    - "getLinearFilterAndPrediction returns struct with filter, prediction, correlation"
    - "MeanSelectedNodes computes and returns mean responses across multiple nodes"
    - "Golden output baselines captured for regression testing"
  artifacts:
    - path: "tests/unit/AnalysisFunctionsTest.m"
      provides: "Tests for all 5 analysis functions"
      contains: "classdef AnalysisFunctionsTest"
    - path: "tests/baselines/README.md"
      provides: "Documentation for golden output baseline files"
      contains: "baseline"
  key_links:
    - from: "tests/unit/AnalysisFunctionsTest.m"
      to: "src/analysis/getMeanResponseTrace.m"
      via: "Direct function call in test methods"
      pattern: "getMeanResponseTrace"
    - from: "tests/unit/AnalysisFunctionsTest.m"
      to: "src/analysis/getResponseAmplitudeStats.m"
      via: "Direct function call"
      pattern: "getResponseAmplitudeStats"
    - from: "tests/unit/AnalysisFunctionsTest.m"
      to: "src/analysis/getCycleAverageResponse.m"
      via: "Direct function call"
      pattern: "getCycleAverageResponse"
    - from: "tests/unit/AnalysisFunctionsTest.m"
      to: "src/analysis/getLinearFilterAndPrediction.m"
      via: "Direct function call"
      pattern: "getLinearFilterAndPrediction"
    - from: "tests/unit/AnalysisFunctionsTest.m"
      to: "src/analysis/MeanSelectedNodes.m"
      via: "Direct function call"
      pattern: "MeanSelectedNodes"
---

<objective>
Validate all 5 analysis functions produce correct output structures with real experiment data, and capture golden output baselines for future regression testing.

Purpose: Analysis functions are the primary value of the tool -- researchers use these to extract scientific results from their data. Incorrect analysis output directly impacts research conclusions. Each function has a well-defined output struct contract that must be validated. Golden baselines ensure future code changes don't silently alter analysis results.

Output: AnalysisFunctionsTest class with format validation AND correctness checks for all 5 analysis functions, golden baseline MAT files, and baseline documentation.
</objective>

<execution_context>
@/Users/maxwellsdm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maxwellsdm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-testing-validation/00-CONTEXT.md
@.planning/phases/00-testing-validation/00-RESEARCH.md

# Must reference Plan 01 summary for test infrastructure
@.planning/phases/00-testing-validation/00-01-SUMMARY.md

# Source files being tested
@src/analysis/getMeanResponseTrace.m
@src/analysis/getResponseAmplitudeStats.m
@src/analysis/getCycleAverageResponse.m
@src/analysis/getLinearFilterAndPrediction.m
@src/analysis/MeanSelectedNodes.m

# Test helpers
@tests/helpers/loadTestTree.m
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write AnalysisFunctionsTest class with format and correctness validation</name>
  <files>
    tests/unit/AnalysisFunctionsTest.m
  </files>
  <action>
Create `tests/unit/AnalysisFunctionsTest.m` inheriting from `matlab.unittest.TestCase`.

Use Claude's discretion for validation depth per the user decision. The recommended approach:
- **Simple output fields** (n, sampleRate, units): verify exact correctness
- **Computed fields** (mean, stdev, SEM): verify format (size, type, non-NaN) + basic mathematical relationships (e.g., SEM = stdev / sqrt(n))
- **Complex outputs** (filter, prediction): verify format + save as golden baseline

Test class structure:
```
classdef AnalysisFunctionsTest < matlab.unittest.TestCase
    properties
        TestTree
        H5File
        LeafNode        % Leaf node with epochs
        MultipleNodes   % Cell array of sibling nodes for MeanSelectedNodes
    end
    methods (TestClassSetup)
        function loadData(testCase)
            [testCase.TestTree, ~, testCase.H5File] = loadTestTree({'cellInfo.type', 'blockInfo.protocol_name'});
            leaves = testCase.TestTree.leafNodes();
            testCase.LeafNode = leaves{1};
            % Get sibling nodes for MeanSelectedNodes
            firstChild = testCase.TestTree.childAt(1);
            testCase.MultipleNodes = {};
            for i = 1:min(3, firstChild.childrenLength())
                testCase.MultipleNodes{end+1} = firstChild.childAt(i);
            end
        end
    end
end
```

Required test methods:

**getMeanResponseTrace:**
- `testMeanResponseTraceOutputFields` - Verify output struct has required fields: mean, stdev, SEM, n, timeVector, sampleRate, units
- `testMeanResponseTraceTypes` - mean is [1 x nSamples] double, n is positive integer, sampleRate is positive double
- `testMeanResponseTraceSEMrelation` - Verify SEM = stdev / sqrt(n) within tolerance (mathematical correctness)
- `testMeanResponseTraceTimeVector` - timeVector length matches mean length, starts near 0
- `testMeanResponseTraceRecordingTypes` - Call with 'exc', 'inh', 'raw' RecordingType options (verify no error, output has appropriate units)
- `testMeanResponseTraceNodeInput` - Accepts epicTreeTools node directly
- `testMeanResponseTraceEpochListInput` - Accepts cell array of epochs

**getResponseAmplitudeStats:**
- `testAmplitudeStatsOutputFields` - Has peakAmplitude, peakTime, integratedResponse, meanAmplitude, baseline, mean_peak, std_peak, sem_peak, n, units
- `testAmplitudeStatsTypes` - peakAmplitude is [nEpochs x 1], summary stats are scalars
- `testAmplitudeStatsSEMrelation` - sem_peak = std_peak / sqrt(n)
- `testAmplitudeStatsNonEmpty` - Fields are non-empty when epochs have data
- `testAmplitudeStatsWithWindow` - Call with explicit ResponseWindow parameter

**getCycleAverageResponse:**
- `testCycleAverageOutputFields` - Has cycleAverage, cycleStd, cycleSEM, cycleTime, F1amplitude, F1phase, F2amplitude, F2phase, F1F2ratio, DC, frequency, nCycles, n
- `testCycleAverageTypes` - cycleAverage is [1 x nPointsPerCycle] double, frequency is positive scalar
- `testCycleAverageWithFrequency` - Call with explicit Frequency parameter
- `testCycleAverageF1F2NonNegative` - F1amplitude and F2amplitude are non-negative
- NOTE: This function requires periodic stimulus epochs. Use `testCase.assumeTrue()` to skip gracefully if no periodic data exists in test set.

**getLinearFilterAndPrediction:**
- `testLinearFilterOutputFields` - Has filter, filterTime, prediction, response, stimulus, correlation, sampleRate, n
- `testLinearFilterTypes` - filter is [1 x filterPoints] double, correlation is scalar in [-1, 1]
- `testLinearFilterCorrelationRange` - correlation is between -1 and 1
- `testLinearFilterWithLength` - Call with explicit FilterLength parameter
- NOTE: This function requires stimulus stream data. Use `testCase.assumeTrue()` to skip if stimulus data unavailable.

**MeanSelectedNodes:**
- `testMeanSelectedNodesOutputFields` - Has meanResponse, semResponse, respAmp, splitValue, nEpochs, timeVector, sampleRate
- `testMeanSelectedNodesTypes` - meanResponse is [nNodes x nSamples], nEpochs is [1 x nNodes]
- `testMeanSelectedNodesDimensions` - Number of rows matches number of input nodes
- `testMeanSelectedNodesWithOptions` - Call with BaselineCorrect=true, verify output changes

Implementation notes:
- Use `testCase.assumeTrue(~isempty(data))` for functions that need specific data types
- Close any figures opened by MeanSelectedNodes in teardown: `testCase.addTeardown(@() close('all'))`
- For MeanSelectedNodes, pass 'Figure' handle to suppress automatic figure creation, or close figures in teardown
- Some analysis functions may need H5 file for real data. Handle gracefully.
- Fix any bugs found and document in TESTING_REPORT.md
  </action>
  <verify>
    Run via MCP MATLAB tools:
    - `results = runtests('tests/unit/AnalysisFunctionsTest');`
    - All tests pass or gracefully skip (0 failures, 0 errors)
    - Output struct fields match documented API contracts
    - Mathematical relationships (SEM = stdev/sqrt(n)) verified
  </verify>
  <done>
    All 5 analysis functions validated for output format, field types, mathematical relationships, and different input modes. Tests pass or gracefully skip when specific data types are unavailable. Any bugs fixed and documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Capture golden output baselines</name>
  <files>
    tests/baselines/README.md
  </files>
  <action>
After all analysis function tests pass, capture golden output baselines for regression testing.

1. Create `tests/baselines/` directory.

2. Create `tests/baselines/README.md` documenting:
   - What baselines are and why they exist
   - How baselines were generated (which test data, which function calls)
   - How to update baselines if intentional changes are made
   - Date of baseline generation
   - MATLAB version used

3. Add a method to AnalysisFunctionsTest (or create a separate script `tests/helpers/generateBaselines.m`) that:
   - Runs each analysis function with the standard test data and default parameters
   - Saves the output struct to a MAT file in tests/baselines/
   - Files: `getMeanResponseTrace_baseline.mat`, `getResponseAmplitudeStats_baseline.mat`, `getCycleAverageResponse_baseline.mat` (if applicable), `getLinearFilterAndPrediction_baseline.mat` (if applicable), `MeanSelectedNodes_baseline.mat`
   - Each MAT file contains the full output struct as variable `baseline`

4. Run the baseline generation to create the initial golden files.

5. Add baseline comparison tests to AnalysisFunctionsTest:
   - `testMeanResponseTraceBaseline` - Load baseline, run function, compare with tolerance (AbsTol 1e-10)
   - `testAmplitudeStatsBaseline` - Same pattern
   - Use `testCase.assumeTrue(isfile(baselinePath))` to skip if baselines don't exist yet

Implementation notes:
- Baselines should be committed to the repository
- Use `save(path, 'baseline', '-v7.3')` for compatibility
- Tolerance should be generous enough to handle floating-point differences across MATLAB versions but tight enough to catch real changes
- Document the exact function calls used to generate baselines in the README
  </action>
  <verify>
    - `tests/baselines/` directory exists with MAT files
    - `tests/baselines/README.md` documents baseline generation
    - Baseline comparison tests pass (output matches saved baselines within tolerance)
    - Baselines are committed to repo
  </verify>
  <done>
    Golden output baselines captured for all applicable analysis functions. Baseline MAT files saved in tests/baselines/. Baseline comparison tests verify current output matches saved baselines within floating-point tolerance. README documents generation process.
  </done>
</task>

</tasks>

<verification>
1. `results = runtests('tests/unit/AnalysisFunctionsTest')` - all pass
2. All 5 analysis functions have format validation tests
3. Mathematical relationships verified (SEM = stdev/sqrt(n))
4. Golden baselines saved in tests/baselines/ as MAT files
5. Baseline comparison tests pass
6. tests/baselines/README.md documents the baseline process
</verification>

<success_criteria>
- getMeanResponseTrace: output struct validated with 7+ fields, SEM relationship verified
- getResponseAmplitudeStats: output struct validated with 10+ fields, summary stats verified
- getCycleAverageResponse: output struct validated (or gracefully skipped if no periodic data)
- getLinearFilterAndPrediction: output struct validated (or gracefully skipped if no stimulus data)
- MeanSelectedNodes: multi-node comparison validated, dimensions match input count
- Golden baselines captured and committed for regression testing
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/00-testing-validation/00-03-SUMMARY.md`
</output>
