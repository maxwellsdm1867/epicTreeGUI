---
phase: 00-testing-validation
plan: 02
type: execute
wave: 2
depends_on: ["00-01"]
files_modified:
  - tests/unit/SplitterFunctionsTest.m
  - tests/unit/DataExtractionTest.m
autonomous: true

must_haves:
  truths:
    - "All 22+ static splitter methods return valid values for real epoch data"
    - "Building a tree with any splitter produces a valid tree structure with no lost epochs"
    - "getSelectedData returns correct data matrix dimensions and sample rate"
    - "getResponseMatrix returns properly formatted response data"
    - "Selection filtering works correctly in data extraction"
  artifacts:
    - path: "tests/unit/SplitterFunctionsTest.m"
      provides: "Parameterized tests for all splitter functions"
      contains: "classdef SplitterFunctionsTest"
    - path: "tests/unit/DataExtractionTest.m"
      provides: "Tests for getSelectedData and getResponseMatrix"
      contains: "classdef DataExtractionTest"
  key_links:
    - from: "tests/unit/SplitterFunctionsTest.m"
      to: "src/tree/epicTreeTools.m"
      via: "Calls all static splitOn* methods"
      pattern: "splitOn"
    - from: "tests/unit/DataExtractionTest.m"
      to: "src/getSelectedData.m"
      via: "Calls getSelectedData with tree nodes"
      pattern: "getSelectedData"
    - from: "tests/unit/DataExtractionTest.m"
      to: "src/getResponseMatrix.m"
      via: "Calls getResponseMatrix"
      pattern: "getResponseMatrix"
---

<objective>
Validate all splitter functions and data extraction functions work correctly with real experiment data.

Purpose: Splitters are the core mechanism that organizes data into tree structures. If any splitter fails silently or returns unexpected values, the entire tree hierarchy becomes unreliable. Data extraction (getSelectedData, getResponseMatrix) is the critical path for all analysis -- every analysis function depends on these returning correct matrices.

Output: SplitterFunctionsTest class with parameterized tests for all 22+ splitters, DataExtractionTest class validating data extraction pipeline correctness.
</objective>

<execution_context>
@/Users/maxwellsdm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maxwellsdm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-testing-validation/00-CONTEXT.md
@.planning/phases/00-testing-validation/00-RESEARCH.md

# Must reference Plan 01 summary for test infrastructure details
@.planning/phases/00-testing-validation/00-01-SUMMARY.md

# Source files being tested
@src/tree/epicTreeTools.m
@src/getSelectedData.m
@src/getResponseMatrix.m
@src/splitters/splitOnCellType.m
@src/splitters/splitOnParameter.m
@src/splitters/splitOnRGCSubtype.m

# Test helpers from Plan 01
@tests/helpers/loadTestTree.m
@tests/helpers/getTestDataPath.m
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write parameterized SplitterFunctionsTest class</name>
  <files>
    tests/unit/SplitterFunctionsTest.m
  </files>
  <action>
Create `tests/unit/SplitterFunctionsTest.m` inheriting from `matlab.unittest.TestCase` with parameterized tests for ALL splitter functions.

First, enumerate all splitters. There are two kinds:
1. **Static methods on epicTreeTools** (22+ functions): splitOnExperimentDate, splitOnCellType, splitOnKeywords, splitOnKeywordsExcluding, splitOnF1F2Contrast, splitOnF1F2CenterSize, splitOnF1F2Phase, splitOnRadiusOrDiameter, splitOnHoldingSignal, splitOnOLEDLevel, splitOnRecKeyword, splitOnLogIRtag, splitOnPatchContrast_NatImage, splitOnPatchSampling_NatImage, splitOnEpochBlockStart, splitOnBarWidth, splitOnFlashDelay, splitOnStimulusCenter, splitOnTemporalFrequency, splitOnSpatialFrequency, splitOnContrast, splitOnProtocol
2. **Standalone splitter files** in src/splitters/: splitOnCellType.m, splitOnParameter.m, splitOnRGCSubtype.m

IMPORTANT: Some splitters take extra arguments (splitOnKeywordsExcluding takes excludeList, splitOnRadiusOrDiameter takes paramString). Read each splitter's signature from epicTreeTools.m to understand arguments. Splitters that require extra args beyond epoch need separate test methods (not parameterized).

Test class structure:
```
classdef SplitterFunctionsTest < matlab.unittest.TestCase
    properties (TestParameter)
        % Only include single-argument splitters in parameterized set
        singleArgSplitter = {
            @epicTreeTools.splitOnExperimentDate,
            @epicTreeTools.splitOnCellType,
            @epicTreeTools.splitOnKeywords,
            ... (all single-arg splitters)
        };
    end
    properties
        TestTree
        TestEpochs
    end
    methods (TestClassSetup)
        function loadData(testCase)
            [testCase.TestTree, ~, ~] = loadTestTree();
            testCase.TestEpochs = testCase.TestTree.getAllEpochs(false);
        end
    end
end
```

Required test methods:

**Parameterized (runs for each single-arg splitter):**
- `testSplitterReturnsValue(testCase, singleArgSplitter)` - Call splitter on first epoch, verify returns non-empty scalar (string, numeric, char, or logical). Try all epochs if first returns empty, since some splitters may not apply to all epoch types.
- `testSplitterDoesNotError(testCase, singleArgSplitter)` - Call splitter on every epoch in test data, verify no errors thrown. Use `testCase.verifyWarningFree(@() ...)` or try/catch with verifyTrue.
- `testTreeBuildWithSplitter(testCase, singleArgSplitter)` - Build tree using `buildTreeWithSplitters({singleArgSplitter})`, verify: childrenLength >= 1, no lost epochs (sum of leaf epochCounts == total epochs).

**Non-parameterized (multi-arg splitters):**
- `testSplitOnKeywordsExcluding` - Call with an empty exclude list, verify returns value
- `testSplitOnRadiusOrDiameter` - Call with 'radius' and 'diameter' paramStrings, verify returns value
- `testStandaloneSplitOnCellType` - Test src/splitters/splitOnCellType.m (different signature from static method)
- `testStandaloneSplitOnParameter` - Test src/splitters/splitOnParameter.m with a known parameter name
- `testStandaloneSplitOnRGCSubtype` - Test src/splitters/splitOnRGCSubtype.m

**Correctness validation:**
- `testSplitOnCellTypeValues` - Verify returned values match known cell types in test data
- `testSplitOnContrastValues` - Verify returned contrast values are numeric and within [0, 1] range
- `testSplitOnProtocolValues` - Verify returned protocol names are non-empty strings
- `testSplitterConsistency` - Same epoch passed twice to same splitter returns same value

Implementation notes:
- Some splitters may return 'Unknown' or 'N/A' for epochs missing certain fields -- this is valid, not a bug
- Some splitters may not apply to all protocol types (e.g., splitOnF1F2Phase only applies to periodic stimuli)
- For splitters that error on certain epochs, catch and categorize: expected (wrong protocol type) vs unexpected (bug)
- Document any bugs found in TESTING_REPORT.md
  </action>
  <verify>
    Run via MCP MATLAB tools:
    - `results = runtests('tests/unit/SplitterFunctionsTest');`
    - All tests pass (0 failures, 0 errors)
    - If splitters fail on certain epoch types, document as expected behavior or bug
  </verify>
  <done>
    SplitterFunctionsTest validates all 22+ static splitters and 3 standalone splitters. Every splitter returns valid values, doesn't error on valid epoch data, and builds valid tree structures. Sum of leaf epoch counts always equals total epoch count (no lost data). Any bugs found are fixed and documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write DataExtractionTest class</name>
  <files>
    tests/unit/DataExtractionTest.m
  </files>
  <action>
Create `tests/unit/DataExtractionTest.m` inheriting from `matlab.unittest.TestCase` to validate getSelectedData and getResponseMatrix.

Test class structure:
```
classdef DataExtractionTest < matlab.unittest.TestCase
    properties
        TestTree
        H5File
        LeafNode    % A leaf node with known epoch count
    end
    methods (TestClassSetup)
        function loadData(testCase)
            [testCase.TestTree, ~, testCase.H5File] = loadTestTree({'cellInfo.type', 'blockInfo.protocol_name'});
            % Find a leaf node with epochs
            leaves = testCase.TestTree.leafNodes();
            testCase.LeafNode = leaves{1};
        end
    end
    methods (TestMethodSetup)
        function resetSelection(testCase)
            % Reset all epochs to selected
            allEpochs = testCase.TestTree.getAllEpochs(false);
            for i = 1:length(allEpochs)
                allEpochs{i}.isSelected = true;
            end
        end
    end
end
```

Required test methods:

**getSelectedData tests:**
- `testGetSelectedDataReturnsMatrix` - Returns [nEpochs x nSamples] double matrix
- `testGetSelectedDataDimensions` - Number of rows matches selected epoch count
- `testGetSelectedDataSampleRate` - Returns positive numeric sample rate
- `testGetSelectedDataEpochs` - Returns cell array of epoch structs
- `testGetSelectedDataWithH5` - Call with h5File argument, verify data loaded
- `testGetSelectedDataSelectionFilter` - Deselect half the epochs, verify returned matrix has fewer rows
- `testGetSelectedDataEmptyNode` - Node with no selected epochs returns empty matrix
- `testGetSelectedDataInvalidStream` - Requesting non-existent stream name handles gracefully (error or empty)
- `testGetSelectedDataFromNode` - Pass epicTreeTools node directly (not epoch list)
- `testGetSelectedDataFromEpochList` - Pass cell array of epochs directly

**getResponseMatrix tests:**
- `testGetResponseMatrixReturnsMatrix` - Returns numeric matrix
- `testGetResponseMatrixDimensions` - Rows match epoch count, columns match sample count
- `testGetResponseMatrixConsistentSampleRate` - All epochs have same sample rate (or verify handling of mixed rates)

**Data integrity tests:**
- `testDataNotAllZeros` - Returned data matrix is not all zeros (real data has signal)
- `testDataNotAllNaN` - No NaN values in returned data
- `testDataConsistentLength` - All rows have same number of columns (no ragged arrays)
- `testSampleRateReasonable` - Sample rate is between 1000 and 50000 Hz (typical neurophysiology range)

Implementation notes:
- The H5 lazy loading may be needed for real data. Check if test data was prepared with embedded responses or needs H5 file.
- If H5 file is needed but not available, document in TESTING_REPORT.md and add a conditional skip for those tests.
- Use `testCase.assumeTrue(~isempty(data), 'Data extraction requires H5 file')` for graceful skip when H5 unavailable.
- Fix any bugs found and document in TESTING_REPORT.md.
  </action>
  <verify>
    Run via MCP MATLAB tools:
    - `results = runtests('tests/unit/DataExtractionTest');`
    - All tests pass (or skip gracefully if H5 data unavailable)
    - Data matrices have expected dimensions
    - Selection filtering correctly reduces row count
  </verify>
  <done>
    DataExtractionTest validates getSelectedData and getResponseMatrix with real data. Data matrices have correct dimensions, sample rates are reasonable, selection filtering works, and edge cases (empty nodes, invalid streams) are handled. Any bugs found are fixed and documented.
  </done>
</task>

</tasks>

<verification>
1. `results = runtests('tests/unit/SplitterFunctionsTest')` - all pass
2. `results = runtests('tests/unit/DataExtractionTest')` - all pass (or graceful skips)
3. Every splitter in epicTreeTools static methods is covered by at least one test
4. getSelectedData works with both node input and epoch list input
5. Selection filtering correctly reduces returned data
6. No lost epochs when building trees with any splitter
</verification>

<success_criteria>
- All 22+ static splitter methods tested for return value, no-error, and tree building
- All 3 standalone splitter files tested
- Splitter correctness validated for key splitters (cell type, contrast, protocol)
- getSelectedData returns correct matrix dimensions matching selected epoch count
- getResponseMatrix returns consistent numeric matrices
- Selection filtering proven to work correctly
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/00-testing-validation/00-02-SUMMARY.md`
</output>
