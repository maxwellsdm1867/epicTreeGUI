---
phase: 00-testing-validation
plan: 04
type: execute
wave: 2
depends_on: ["00-01"]
files_modified:
  - tests/utilities/TreeNavigationUtility.m
  - tests/gui/GUIInteractionTest.m
autonomous: true

must_haves:
  truths:
    - "TreeNavigationUtility can programmatically navigate tree structure without manual clicking"
    - "TreeNavigationUtility can control GUI checkbox selection state"
    - "GUI launches successfully with pre-built tree"
    - "Tree browser displays correct node hierarchy"
    - "Checkbox state changes propagate to epoch selection state"
    - "Node selection triggers data display update"
  artifacts:
    - path: "tests/utilities/TreeNavigationUtility.m"
      provides: "Command-line tree navigation and checkbox control utility"
      contains: "classdef TreeNavigationUtility"
    - path: "tests/gui/GUIInteractionTest.m"
      provides: "Automated GUI interaction tests"
      contains: "classdef GUIInteractionTest"
  key_links:
    - from: "tests/utilities/TreeNavigationUtility.m"
      to: "epicTreeGUI.m"
      via: "GUI handle for tree access and checkbox control"
      pattern: "epicTreeGUI"
    - from: "tests/utilities/TreeNavigationUtility.m"
      to: "src/gui/graphicalCheckBox.m"
      via: "Programmatic checkbox toggle"
      pattern: "graphicalCheckBox"
    - from: "tests/gui/GUIInteractionTest.m"
      to: "tests/utilities/TreeNavigationUtility.m"
      via: "Uses utility for GUI interaction"
      pattern: "TreeNavigationUtility"
---

<objective>
Build the command-line testing utility for programmatic tree navigation and checkbox control, and write automated GUI interaction tests.

Purpose: The user explicitly requires a testing utility that provides programmatic access to tree navigation and GUI checkbox control (per locked decision). This enables testing tree interaction without manual clicking. The GUI is the primary user interface -- automated tests catch regressions in tree display, checkbox behavior, selection propagation, and node data display.

Output: TreeNavigationUtility class for command-line tree/checkbox control, GUIInteractionTest class with automated GUI tests.
</objective>

<execution_context>
@/Users/maxwellsdm/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maxwellsdm/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-testing-validation/00-CONTEXT.md
@.planning/phases/00-testing-validation/00-RESEARCH.md

# Must reference Plan 01 summary for test infrastructure
@.planning/phases/00-testing-validation/00-01-SUMMARY.md

# Source files being tested/wrapped
@epicTreeGUI.m
@src/gui/epicGraphicalTree.m
@src/gui/epicGraphicalTreeNode.m
@src/gui/graphicalCheckBox.m
@src/gui/graphicalTree.m
@src/gui/graphicalTreeNode.m
@src/gui/graphicalTreeNodeWidget.m

# Reference for testing utility design
@tests/test_selection_navigation.m

# Test helpers
@tests/helpers/loadTestTree.m
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build TreeNavigationUtility class</name>
  <files>
    tests/utilities/TreeNavigationUtility.m
  </files>
  <action>
Create `tests/utilities/TreeNavigationUtility.m` -- a handle class that wraps the epicTreeGUI for programmatic tree navigation and checkbox control.

CRITICAL: Read the epicTreeGUI.m code first to understand:
1. How the GUI stores its graphicalTree reference (likely `self.treeBrowser` or similar property)
2. How graphicalTreeNode/epicGraphicalTreeNode maps to epicTreeTools nodes
3. How graphicalCheckBox.isChecked relates to epoch.isSelected
4. How the GUI's `marryEpochNodesToWidgets` connects tree nodes to graphical widgets

Then read `src/gui/epicGraphicalTree.m` and `src/gui/epicGraphicalTreeNode.m` to understand:
1. How to find a graphical node corresponding to a tree node
2. How checkbox state change callback works
3. How to programmatically trigger the same behavior as clicking a checkbox

Class design:
```
classdef TreeNavigationUtility < handle
    properties
        GUI           % epicTreeGUI handle
        CurrentNode   % Current epicTreeTools node
    end

    methods
        function obj = TreeNavigationUtility(gui)
            % Attach to existing GUI instance
            obj.GUI = gui;
            obj.CurrentNode = gui.tree;  % Start at root
        end

        % --- Navigation methods ---
        function navigateToChild(obj, indexOrName)
            % Navigate by index (numeric) or splitValue (string)
        end

        function navigateToParent(obj)
            % Go up one level
        end

        function navigateToRoot(obj)
            % Return to root
        end

        function navigateToNode(obj, varargin)
            % Navigate by path of splitValues
            % Usage: util.navigateToNode('OnP', 'SingleSpot')
        end

        function info = getCurrentNodeInfo(obj)
            % Return struct with: splitValue, epochCount, selectedCount, depth, childCount, isLeaf
        end

        % --- Checkbox/Selection methods ---
        function toggleCheckbox(obj, selected)
            % Set checkbox state on current node's graphical widget
            % MUST interact with actual GUI checkbox, not just setSelected()
            % Find the graphical node, access its checkbox, toggle it
            % This should trigger the same callback chain as a mouse click
        end

        function toggleCheckboxRecursive(obj, selected)
            % Set checkbox on current node and all descendants
        end

        function selectAll(obj)
            % Select all nodes in entire tree
        end

        function deselectAll(obj)
            % Deselect all nodes in entire tree
        end

        % --- Data extraction ---
        function [data, epochs, fs] = extractData(obj, streamName)
            % Get selected data from current node
        end

        % --- Tree display ---
        function printTree(obj, maxDepth)
            % Print tree structure from current node with indentation
            % Shows: splitValue, epochCount, selectedCount, [*] if selected
        end

        function printChildren(obj)
            % Print immediate children of current node
        end

        % --- GUI sync ---
        function highlightCurrentNode(obj)
            % Highlight current node in the GUI tree display
            % Programmatically trigger the GUI's node selection callback
        end
    end

    methods (Access = private)
        function graphNode = findGraphicalNode(obj, treeNode)
            % Walk the graphical tree to find the widget matching treeNode
            % Match by comparing the underlying epicTreeTools node reference
        end

        function printNodeRecursive(obj, node, depth, maxDepth)
            % Recursive helper for printTree
        end
    end
end
```

Key implementation challenge: Mapping between epicTreeTools nodes and graphical tree nodes. The GUI's `marryEpochNodesToWidgets` method connects them -- study this to understand the mapping. The graphical node likely stores a reference to the data node, or vice versa.

For checkbox control, the requirement is explicitly "actual GUI checkboxes" not just setSelected(). This means:
1. Find the graphicalTreeNodeWidget for the current node
2. Access its graphicalCheckBox
3. Call the checkbox's toggle/setValue method
4. This should trigger the callback chain that updates isSelected on the epoch data

If the checkbox callback chain is complex, call both: the graphical checkbox update AND the setSelected() to ensure consistency. Document the approach.
  </action>
  <verify>
    Run via MCP MATLAB tools:
    ```matlab
    [tree, ~, ~] = loadTestTree({'cellInfo.type', 'blockInfo.protocol_name'});
    gui = epicTreeGUI(tree);
    util = TreeNavigationUtility(gui);
    util.printTree(2);  % Should print tree structure
    util.navigateToChild(1);
    info = util.getCurrentNodeInfo();  % Should return valid info
    util.toggleCheckbox(false);  % Should deselect
    util.toggleCheckbox(true);   % Should reselect
    close(gui.figure);
    ```
  </verify>
  <done>
    TreeNavigationUtility provides programmatic tree navigation (navigate by index, name, path), checkbox control (toggle individual and recursive), data extraction, and tree display. Checkbox control interacts with actual GUI checkboxes, not just setSelected(). Utility lives in tests/utilities/ directory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write GUIInteractionTest class</name>
  <files>
    tests/gui/GUIInteractionTest.m
  </files>
  <action>
Create `tests/gui/GUIInteractionTest.m` inheriting from `matlab.unittest.TestCase`.

IMPORTANT: The GUI uses `figure()` not `uifigure()`, so `matlab.uitest.TestCase` (App Testing Framework) will NOT work. Use standard `matlab.unittest.TestCase` with programmatic GUI interaction via the TreeNavigationUtility and direct property access.

Test class structure:
```
classdef GUIInteractionTest < matlab.unittest.TestCase
    properties
        GUI
        Utility
        TestTree
    end
    methods (TestMethodSetup)
        function launchGUI(testCase)
            [testCase.TestTree, ~, ~] = loadTestTree({'cellInfo.type', 'blockInfo.protocol_name'});
            testCase.GUI = epicTreeGUI(testCase.TestTree);
            testCase.Utility = TreeNavigationUtility(testCase.GUI);
            % Teardown: close GUI after each test
            testCase.addTeardown(@() close(testCase.GUI.figure));
            % Small pause to let GUI render
            drawnow;
        end
    end
end
```

Required test methods:

**GUI Launch:**
- `testGUILaunchesSuccessfully` - GUI figure is valid handle, figure is visible
- `testGUIHasTreeBrowser` - Tree browser panel exists and is populated
- `testGUIHasPlottingCanvas` - Plotting/viewer panel exists
- `testGUIHasMenuBar` - Menu bar exists with expected menu items

**Tree Display:**
- `testTreeDisplaysRootNode` - Root node visible in tree browser
- `testTreeDisplaysChildren` - First-level children visible (cell types)
- `testTreeNodeCount` - Number of displayed nodes matches expected from tree structure

**Checkbox Interaction (via TreeNavigationUtility):**
- `testCheckboxDefaultState` - Verify initial checkbox state (all selected by default)
- `testCheckboxToggleOff` - Use utility to deselect a node, verify epoch.isSelected changed
- `testCheckboxToggleOn` - Re-select, verify state restored
- `testCheckboxRecursiveDeselect` - Deselect parent, verify all children deselected
- `testCheckboxPropagation` - Toggle checkbox via utility, verify getSelectedEpochTreeNodes reflects change

**Node Selection:**
- `testNodeSelectionUpdatesViewer` - Select a node via utility.highlightCurrentNode(), verify viewer panel updates (or at least doesn't error)
- `testSelectDifferentNodes` - Navigate to different nodes, verify each selection works

**Data Display:**
- `testPlotNodeDataNoError` - Call GUI's plotNodeData method on a leaf node, verify no error
- `testInfoTableUpdates` - After selecting a node, info table should reflect that node's data

**Edge Cases:**
- `testGUICloseNoError` - Close GUI cleanly without error
- `testMultipleGUIInstances` - Can launch two GUIs simultaneously without interference
- `testEmptyTreeNode` - Navigate to a node with no epochs (if possible), verify no crash

Implementation notes:
- Since epicTreeGUI uses traditional figure(), test via property access and method calls
- Use `drawnow` after GUI operations to ensure rendering completes
- Each test method gets a fresh GUI (TestMethodSetup, not TestClassSetup) to avoid state leakage
- If the GUI takes >2 seconds to launch per test, switch to TestClassSetup with careful state reset
- Fix any bugs found and document in TESTING_REPORT.md
- Close all figures in teardown to prevent figure accumulation
  </action>
  <verify>
    Run via MCP MATLAB tools:
    - `results = runtests('tests/gui/GUIInteractionTest');`
    - All tests pass (0 failures, 0 errors)
    - GUI launches and closes cleanly for each test
    - Checkbox state changes propagate correctly
  </verify>
  <done>
    GUIInteractionTest validates GUI launch, tree display, checkbox interaction (via TreeNavigationUtility), node selection, data display, and edge cases. All tests use programmatic interaction (no manual clicking). GUI uses figure() not uifigure() so tests use property/method access instead of App Testing Framework. Zero test failures.
  </done>
</task>

</tasks>

<verification>
1. `tests/utilities/TreeNavigationUtility.m` exists and provides programmatic navigation + checkbox control
2. `results = runtests('tests/gui/GUIInteractionTest')` - all pass
3. TreeNavigationUtility checkbox control interacts with actual GUI checkboxes
4. GUI launches and closes cleanly in automated tests
5. Checkbox state changes propagate to epoch selection state
6. No figure handles leaked between tests
</verification>

<success_criteria>
- TreeNavigationUtility provides navigate (by index, name, path), checkbox toggle, data extraction, and tree print
- Checkbox control goes through actual GUI graphicalCheckBox objects (per user requirement)
- GUI automated tests cover: launch, tree display, checkbox interaction, node selection, data display, edge cases
- All tests pass without manual interaction
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/00-testing-validation/00-04-SUMMARY.md`
</output>
