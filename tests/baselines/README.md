# Analysis Function Golden Baselines

This directory contains golden output baselines for regression testing of the 5 core analysis functions in epicTreeGUI.

## Purpose

Golden baselines capture the expected output of analysis functions when run against known test data. They serve as regression tests to ensure that future code changes don't silently alter analysis results. This is critical because these analysis functions directly impact scientific research conclusions.

## What Are Baselines?

Each baseline is a MAT file containing the complete output struct from running an analysis function with standard parameters on the test dataset located at:
```
/Users/maxwellsdm/Documents/epicTreeTest/analysis/2025-12-02_F.mat
```

## Baseline Files

### Current Baselines

1. **getMeanResponseTrace_baseline.mat**
   - Function: `getMeanResponseTrace(leafNode, 'Amp1')`
   - Contains: Mean response trace with statistics (mean, stdev, SEM, timeVector, sampleRate)
   - Purpose: Validates basic response averaging and time series computation

2. **getResponseAmplitudeStats_baseline.mat**
   - Function: `getResponseAmplitudeStats(leafNode, 'Amp1')`
   - Contains: Peak amplitude, integrated response, and summary statistics
   - Purpose: Validates response quantification and peak detection

3. **getCycleAverageResponse_baseline.mat** (if applicable)
   - Function: `getCycleAverageResponse(leafNode, 'Amp1', 'Frequency', 2)`
   - Contains: Cycle-averaged response with F1/F2 harmonic analysis
   - Purpose: Validates periodic stimulus analysis
   - Note: Only generated if test data contains periodic stimuli

4. **getLinearFilterAndPrediction_baseline.mat** (if applicable)
   - Function: `getLinearFilterAndPrediction(leafNode, 'Stage', 'Amp1')`
   - Contains: Linear filter, prediction, and correlation
   - Purpose: Validates linear systems analysis
   - Note: Only generated if test data contains stimulus streams

5. **MeanSelectedNodes_baseline.mat**
   - Function: `MeanSelectedNodes(multipleNodes, 'Amp1', 'Figure', fig)`
   - Contains: Multi-node comparison results (meanResponse, semResponse, respAmp)
   - Purpose: Validates cross-condition comparison analysis

## Generation Details

**Date Generated:** 2026-02-07

**MATLAB Version:** R2023b (or current version)

**Test Data:**
- Tree structure: Split by `cellInfo.type` then `blockInfo.protocol_name`
- Leaf node: First leaf from tree (contains real experiment epochs)
- Multiple nodes: First 3 sibling nodes under first cell type

**Generation Process:**
Baselines are generated by the script `tests/helpers/generateBaselines.m` which:
1. Loads test data using `loadTestTree()`
2. Runs each analysis function with default parameters
3. Saves the complete output struct as variable `baseline` in a MAT file
4. Uses `-v7.3` format for MATLAB version compatibility

## How to Use Baselines

### Automatic Regression Tests

The test class `tests/unit/AnalysisFunctionsTest.m` automatically compares current function output to baselines when the baseline files exist. Tests use floating-point tolerance (`AbsTol = 1e-10`) to handle minor numerical differences across MATLAB versions.

### Manual Baseline Verification

To manually check if current output matches baselines:

```matlab
% Load baseline
baselineData = load('tests/baselines/getMeanResponseTrace_baseline.mat');
baseline = baselineData.baseline;

% Run function
[tree, ~, h5] = loadTestTree({'cellInfo.type', 'blockInfo.protocol_name'});
leaves = tree.leafNodes();
current = getMeanResponseTrace(leaves{1}, 'Amp1');

% Compare
assert(current.n == baseline.n, 'Epoch count mismatch');
assert(max(abs(current.mean - baseline.mean)) < 1e-10, 'Mean trace changed');
```

## Updating Baselines

**When to Update:**
Only update baselines when you've intentionally changed analysis function behavior and verified the new output is correct.

**DO NOT update baselines if:**
- Tests are failing and you don't know why
- You've refactored code but expect identical output
- A test failure reveals an unintended bug

**How to Update:**

1. Verify the new output is scientifically correct
2. Run the baseline generation script:
   ```matlab
   cd tests/helpers
   generateBaselines()
   ```
3. Review the changes using git diff:
   ```bash
   git diff tests/baselines/*.mat
   ```
   (MAT files are binary, so you'll see metadata changes only)
4. Commit the updated baselines with a clear message:
   ```bash
   git add tests/baselines/*.mat
   git commit -m "test: update baselines after fixing peak detection algorithm"
   ```
5. Document the change in the commit message and in relevant PR/issue

## Tolerance Levels

The baseline comparison tests use these tolerance levels:

- **Exact match:** Epoch counts, units strings
- **AbsTol = 1e-6:** Sample rates, frequencies (measured quantities)
- **AbsTol = 1e-10:** Computed statistics (mean, SEM, correlations)

These tolerances account for:
- Floating-point arithmetic differences across MATLAB versions
- Minor differences in library implementations (e.g., `std()`, `corrcoef()`)
- Platform-specific numerical precision (Mac vs Windows vs Linux)

## Baseline Verification

Before committing baselines, verify:
1. MAT files are in MATLAB v7.3 format (compatible across versions)
2. Each file contains a single struct variable named `baseline`
3. Baseline structs match documented API contracts in function headers
4. File sizes are reasonable (typically < 100 KB per baseline)

## Troubleshooting

**Test fails: "Baseline file must exist for regression test"**
- Baselines haven't been generated yet
- Run `generateBaselines()` to create them
- Tests will automatically skip baseline comparison until files exist

**Test fails: "Mean trace should match baseline"**
- Either the function output changed (intended or bug)
- Or numerical precision differences exceeded tolerance
- Investigate by printing `max(abs(current.mean - baseline.mean))`
- If < 1e-8, might need to increase tolerance slightly
- If > 1e-8, likely a real change in function behavior

**Baseline generation fails with "no such file"**
- Check test data path in `tests/helpers/getTestDataPath.m`
- Ensure test MAT file exists at expected location
- Try loading test data manually to diagnose issue

## Additional Notes

- Baselines are committed to the repository (unlike test data which may be external)
- Baseline files should be relatively small (< 1 MB total)
- If baselines grow too large, consider saving only summary statistics
- Baselines assume test data doesn't change; if test data changes, regenerate baselines
- Some baselines may be empty or sparse if test data lacks required stimulus types
